!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("natty-storage")):"function"==typeof define&&define.amd?define("nattyFetch",["natty-storage"],t):"object"==typeof exports?exports.nattyFetch=t(require("natty-storage")):e.nattyFetch=t(e.nattyStorage)}(this,function(e){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";e.exports=r(1)},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a="undefined"!=typeof window,i=r(2);void 0===i&&console.warn("Please install the `natty-storage` script which is required by `natty-fetch`, go on with https://www.npmjs.com/package/natty-storage");var s=r(3),c=r(5),u=r(6),l=r(4),p=r(7),f=r(8),d=r(9),m=l.extend,h=l.runAsFn,v=l.isAbsoluteUrl,g=l.isRelativeUrl,y=l.noop,b=l.isBoolean,j=l.isArray,k=l.isFunction,w=l.sortPlainObjectKey,_=l.isEmptyObject,x=l.isPlainObject,q=l.dummyPromise,O=l.isString,S=null,P="",C=!0,R=!C,N={data:{},didFetch:y,fit:y,header:{},ignoreSelfConcurrent:R,jsonp:R,log:R,method:"GET",mock:R,mockUrl:P,mockUrlPrefix:P,process:y,Promise:a?window.Promise:S,retry:0,customRequest:S,timeout:0,traditional:R,url:P,urlPrefix:P,urlStamp:C,withCredentials:S,willFetch:y,storage:!1,plugins:!1},E=m({},N),T=function(){function e(t,r,o,a){n(this,e);var i=this;i.contextConfig=o,i._path=t;var s=i.config=i.processAPIOptions(r);i.api=function(e){if(e=e||{},s.ignoreSelfConcurrent&&i.api.pending)return q;s.overrideSelfConcurrent&&i.api._requester&&i.api._requester.abort();var t=i.makeVars(e);return 0===s.retry?i.request(t,s):i.tryRequest(t,s)},i.api.contextId=a,i.api._path=t,i.api.pending=R,i.api._requester=S,i.api.abort=function(){i.api.pending&&i.api._requester&&i.api._requester.abort()},i.api.config=s,i.initStorage();for(var c=j(s.plugins)?s.plugins:[],u=0,l=c.length;l>u;u++)k(c[u])&&c[u].call(i,i)}return o(e,[{key:"makeVars",value:function(e){var t=this,r=t.config,n={mark:{__api:t._path}};return r.mock&&(n.mark.__mock=C),r.urlStamp&&(n.mark.__stamp=+new Date),e=m({},r.data,h(e)),n.data=e,n}},{key:"processAPIOptions",value:function(e){var t=this,r=[].concat(t.contextConfig.plugins||[],e.plugins||[]),n=m({},t.contextConfig,e,{plugins:r});return n.mock&&(n.mockUrl=t.getFullUrl(n)),n.url=t.getFullUrl(n),j(e.jsonp)&&(n.jsonp=b(e.jsonp[0])?e.jsonp[0]:R,n.jsonp&&(n.jsonpFlag=e.jsonp[1],n.jsonpCallbackName=e.jsonp[2])),!n.mock&&n.url.match(/\.jsonp(\?.*)?$/)&&(n.jsonp=C),n}},{key:"initStorage",value:function(){var e=this,t=e.config,r="GET"===t.method||t.jsonp;if(!r&&t.storage===C)throw new Error("A `"+t.method+"` request CAN NOT use `storage` which is only for `GET/jsonp` request! Please check the options for `"+e._path+"`");if(t.storage===C&&(t.storage={type:"variable"}),e.api.storageUseable=x(t.storage)&&("GET"===t.method||t.jsonp)&&i.support[t.storage.type],e.api.storageUseable){if("localStorage"===t.storage.type){if(!t.storage.hasOwnProperty("key")||!t.storage.key)throw new Error("`key` is required when `storage.type` is `localStorage`.")}else t.storage.key=t.storage.key||[e.api.contextId,e._path].join("_");e.api.storage=i(m({},t.storage,{async:C,tag:[t.storage.tag,t.jsonp?"jsonp":t.method,t.url].join("_")}))}}},{key:"request",value:function(e,t){var r=this;return r.api.storageUseable?(e.queryString=_(e.data)?"no-query-string":JSON.stringify(w(e.data)),r.api.storage.has(e.queryString).then(function(n){return n.has?n.value:r.remoteRequest(e,t)})):r.remoteRequest(e,t)}},{key:"getFullUrl",value:function(e){var t=e.mock?e.mockUrl:e.url;if(!t)return P;var r=e.mock?"mockUrlPrefix":"urlPrefix";return!e[r]||v(t)||g(t)?t:e[r]+t}},{key:"remoteRequest",value:function(e,t){var r=this;t.willFetch(e,t,"remote"),r.api.pending=C;var n=new u(t.Promise);return t.customRequest?r.api._requester=t.customRequest(e,t,n):t.jsonp?r.api._requester=r.sendJSONP(e,t,n):r.api._requester=r.sendAjax(e,t,n),0!==t.timeout&&setTimeout(function(){if(r.api.pending&&r.api._requester){r.api._requester.abort();var e={timeout:C,message:"Timeout By "+t.timeout+"ms."};n.reject(e),p.fire("g.reject",[e,t]),p.fire(r.api.contextId+".reject",[e,t])}},t.timeout),n.promise}},{key:"tryRequest",value:function(e,t){var r=this;return new t.Promise(function(n,o){var a=0,i=function s(){e.mark.__retryTime=a,r.request(e,t).then(function(e){n(e),p.fire("g.resolve",[e,t],t),p.fire(r.api.contextId+".resolve",[e,t],t)},function(e){a===t.retry?o(e):(a++,s())})};i()})}},{key:"processResponse",value:function(e,t,r,n){var o=this;if(t.didFetch(e,t),n=t.fit(n,e),n.success)!function(){var a=t.process(n.content,e),i=function(){r.resolve(a),p.fire("g.resolve",[a,t],t),p.fire(o.api.contextId+".resolve",[a,t],t)};o.api.storageUseable?o.api.storage.set(e.queryString,a).then(function(){i()})["catch"](function(e){i()}):i()}();else{var a=m({message:"`success` is false, "+o._path},n.error);r.reject(a),p.fire("g.reject",[a,t]),p.fire(o.api.contextId+".reject",[a,t])}}},{key:"sendAjax",value:function(e,t,r){var n=this;return s({traditional:t.traditional,cache:t.cache,mark:e.mark,log:t.log,url:t.mock?t.mockUrl:t.url,method:t.method,data:e.data,header:t.header,withCredentials:t.withCredentials,accept:"json",success:function(o){n.processResponse(e,t,r,o)},error:function o(a){var i=void 0;switch(a){case 404:i="Not Found";break;case 500:i="Internal Server Error";break;default:i="Unknown Server Error"}var o={status:a,message:i+": "+e.mark.__api};r.reject(o),p.fire("g.reject",[o,t]),p.fire(n.api.contextId+".reject",[o,t])},complete:function(){void 0!==e.retryTime&&e.retryTime!==t.retry||(n.api.pending=R,n.api._requester=S)}})}},{key:"sendJSONP",value:function(e,t,r){var n=this;return c({traditional:t.traditional,log:t.log,mark:e.mark,url:t.mock?t.mockUrl:t.url,data:e.data,cache:t.cache,flag:t.jsonpFlag,callbackName:t.jsonpCallbackName,success:function(o){n.processResponse(e,t,r,o)},error:function o(){var o={message:"Not Accessable JSONP: "+e.mark.__api};r.reject(o),p.fire("g.reject",[o,t]),p.fire(n.api.contextId+".reject",[o,t])},complete:function(){void 0!==e.retryTime&&e.retryTime!==t.retry||(n.api.pending=R,n.api._requester=S)}})}}]),e}(),U=function(){var e=0;return function(t,r){O(t)?r=r||{}:(r=t||{},t="c"+e++);var n=i({type:"variable",key:t}),o={};o.api=n.get(),o._contextId=t;var a=[].concat(E.plugins||[],r.plugins||[]);return o._config=m({},E,r,{plugins:a}),o.create=function(e,r){var a=2===arguments.length&&O(e);a||(r=e);for(var i in r)n.set(a?e+"."+i:i,new T(a?e+"."+i:i,h(r[i]),o._config,t).api);o.api=n.get()},o.on=function(e,t){return k(t)?(p.on(o._contextId+"."+e,t),o):void 0},o}}(),F=void 0;F="2.1.3";var A=void 0;A=!0;var I={};I.create=function(e){return new T("nattyFetch",h(e),N,"global").api},m(I,{onlyForModern:A,version:F,_util:l,_event:p,context:U,ajax:s,jsonp:c,setGlobal:function(e){return E=m({},N,e),this},getGlobal:function(e){return e?E[e]:E},on:function(e,t){return k(t)?(p.on("g."+e,t),this):void 0},plugin:{loop:f,soon:d}}),I.setGlobal(N),e.exports=I},function(t,r){t.exports=e},function(e,t,r){"use strict";var n=r(4),o=n.extend,a=n.appendQueryString,i=n.noop,s=n.isCrossDomain,c=n.isBoolean,u=n.param,l=!1,p="undefined",f=null,d="GET",m="script",h="xml",v="json",g=p!==typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,y={"*":"*/*",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript",json:"application/json, text/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},b=function(e,t){var r={Accept:y[t.accept]};s(t.url)||(r["X-Requested-With"]="XMLHttpRequest"),o(r,t.header),"POST"!==t.method||t.header["Content-Type"]||(r["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8");for(var n in r)e.setRequestHeader(n,r[n])},j=function(e,t){e.__finished=l;var r=function(r){if(4===e.readyState)if(e.status>=200&&e.status<300||304===e.status){var n=e.responseText;switch(t.accept){case v:try{n=JSON.parse(n)}catch(r){console.warn("The response can NOT be parsed to JSON object.",n)}break;case m:(0,eval)(n);break;case h:n=e.responseXML}t.success(n,e)}else!e.__aborted&&t.error(e.status,e)};e.addEventListener("readystatechange",r);var n=function(){e.__finished||t.abort(e.status,e)};e.addEventListener("abort",n);var o=function(){e.__finished||(e.__finished=!0,t.complete(e.status,e),delete e.__aborted)};e.addEventListener("loadend",o)},k={url:"",mark:{},method:d,accept:"*",data:null,header:{},withCredentials:f,success:i,error:i,complete:i,abort:i,log:l,traditional:l},w=function(e){e=o({},k,e),s(e.url)&&(e.header={});var t=new XMLHttpRequest;j(t,e),t.open(e.method,a(e.url,o({},e.mark,e.method===d?e.data:{}),e.traditional)),t.withCredentials=c(e.withCredentials)?e.withCredentials:s(e.url),b(t,e),t.send(e.method===d?f:e.data!==f?u(e.data,e.traditional):f);var r=t.abort;return t.abort=function(){t.__aborted=!0,r.call(t)},t};w.fallback=!1,w.supportCORS=g,e.exports=w},function(e,t,r){"use strict";var n="undefined"!=typeof window,o=n?document:null,a=encodeURIComponent,i=null,s=Object.prototype.toString,c="[object Array]",u="[object Object]",l=!0,p=!l,f={dummy:l};f.then=f["catch"]=function(){return f};var d=n&&(!!window.ActiveXObject||"ActiveXObject"in window),m=function(e){return e},h=function(e){return function(){for(var t=arguments,r=e(t[0],t[1]),n=2,o=t.length;o>n;n++)r=e(r,t[n]);return r}},v=Math.random,g=Math.floor,y=function(){return g(9e9*v())},b=/^(https?:)?\/\//,j=function(e){return!!e.match(b)},k=/^[\.\/]/,w=function(e){return!!e.match(k)},_="boolean",x=function(e){return typeof e===_},q="string",O=function(e){return typeof e===q},S="function",P=function(e){return typeof e===S},C=function(e){return P(e)?e():e},R="number",N=function(e){return!isNaN(e)&&typeof e===R},E="object",T=function(e){return typeof e===E&&e!==i},U=function(e){return e!==i&&e===e.window},F=function(e){return e!==i&&T(e)&&!U(e)&&Object.getPrototypeOf(e)===Object.prototype},A=function(e){var t=0;for(var r in e)e.hasOwnProperty(r)&&t++;return 0===t},I=Array.isArray,L=void 0;o&&(L=o.createElement("a"),L.href=location.href);var G=function(e){var t=o.createElement("a");return t.href=e,L.hostname!==t.hostname||L.port!==t.port||L.protocol!==t.protocol},M=function Q(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=arguments.length<=2||void 0===arguments[2]?p:arguments[2];for(var n in t)t.hasOwnProperty(n)&&void 0!==t[n]&&(r===l?I(t[n])?e[n]=[].concat(t[n]):F(t[n])?e[n]=Q({},t[n]):e[n]=t[n]:e[n]=t[n]);return e},X=function(e){return e?typeof e.length===R:!1},J=function(e,t){var r=void 0,n=void 0;if(X(e)){for(r=0,n=e.length;n>r;r++)if(t.call(e[r],e[r],r)===!1)return}else for(r in e)if(t.call(e[r],e[r],r)===!1)return},B=function W(e){var t={},r=void 0,n=[];for(r in e)e.hasOwnProperty(r)&&(n.push(r),F(e[r])&&(e[r]=W(e[r])));n.sort();for(var o=0,a=n.length;a>o;o++)t[n[o]]=e[n[o]];return t},H=function $(e,t,r,n){var o=void 0,a=I(t),i=F(t);J(t,function(t,l){o=s.call(t),n&&(l=r?n:n+"["+(i||o==u||o==c?l:"")+"]"),!n&&a?e.add(t.name,t.value):o==c||!r&&o==u?$(e,t,r,l):e.add(l,t)})},V=function(e,t){var r=[];return r.add=function(e,t){P(t)&&(t=t()),t==i&&(t=""),r.push(a(e)+"="+a(t))},H(r,e,t),r.join("&").replace(/%20/g,"+")},D=function(e){return decodeURIComponent(e.replace(/\+/g," "))},K=function(e,t,r){var n=V(t,r);return n?e+(~e.indexOf("?")?"&":"?")+n:e};e.exports={appendQueryString:K,decodeParam:D,dummyPromise:f,each:J,extend:h(M),isAbsoluteUrl:j,isArray:I,isBoolean:x,isCrossDomain:G,isEmptyObject:A,isFunction:P,isIE:d,isNumber:N,isPlainObject:F,isRelativeUrl:w,isString:O,makeRandom:y,noop:m,sortPlainObjectKey:B,param:V,runAsFn:C}},function(e,t,r){"use strict";function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var o=r(4),a=o.appendQueryString,i=o.noop,s=o.extend,c=o.makeRandom,u="undefined"!=typeof window,l=u?window:null,p=u?document:null,f=null,d="script",m=!1,h=function(e){e.onerror=f,e.parentNode.removeChild(e)},v=f,g=function(e,t){var r=p.createElement(d);return r.src=e,r.async=!0,r.onerror=function(e){l[t.callbackName]=f,t.error(e),t.complete()},v=v||p.getElementsByTagName("head")[0],v.insertBefore(r,v.firstChild),r},y={url:"",mark:{},data:{},success:i,error:i,complete:i,log:!1,flag:"callback",callbackName:"jsonp{id}",traditional:m},b=function(e){e=s({},y,e);var t=e.callbackName=e.callbackName.replace(/\{id\}/,c()),r=e.complete,o=void 0;e.complete=function(){h(o),r()},l[t]=function(r){l[t]=f,e.success(r),e.complete()};var i=a(e.url,s(n({},e.flag,t),e.mark,e.data),e.traditional);return o=g(i,e),{abort:function(){l[t]=function(){l[t]=f},h(o)}}};e.exports=b},function(e,t){"use strict";function r(e){var t=this;t.promise=new e(function(e,r){t._resolve=e,t._reject=r})}r.prototype.resolve=function(e){this._resolve.call(this.promise,e)},r.prototype.reject=function(e){this._reject.call(this.promise,e)},e.exports=r},function(e,t){"use strict";function r(e){return n+e}var n="__",o={on:function(){var e=this,t=arguments;if("string"==typeof t[0]&&"function"==typeof t[1]){var n=r(t[0]);e[n]=e[n]||[],e[n].push(t[1])}else if("object"==typeof t[0]){var o=t[0];for(var a in o)e.on(a,o[a])}},off:function(e,t){var n=this,e=r(e);if(t){var o=n[e];o.splice(o.indexOf(t),1),n[e].length||delete n[e]}else delete n[e]},fire:function(e,t,n){var o=this,a=o[r(e)];if(!a)return"NO_EVENT";for(var i,s=0;i=a[s];s++)i.apply(n||o,[].concat(t))},hasEvent:function(e){return!!this[r(e)]}};e.exports=o},function(e,t,r){"use strict";var n=!1,o=!0,a=null,i=r(4),s=i.isNumber,c=i.noop;e.exports=function(e){var t=e.api;t.loop=function(e){var r=arguments.length<=1||void 0===arguments[1]?c:arguments[1],i=arguments.length<=2||void 0===arguments[2]?c:arguments[2];if(!e.duration||!s(e.duration))throw new Error("Illegal `duration` value for `startLoop` method.");var u=a,l=function f(){clearTimeout(u),u=a,f.looping=n},p=function d(){l.looping=o,u=setTimeout(function(){t(e.data).then(r,i),d()},e.duration)};return t(e.data).then(r,i),p(),l}}},function(e,t,r){"use strict";var n=!1,o=!0,a=r(4),i=a.noop,s=a.isEmptyObject,c=a.sortPlainObjectKey;e.exports=function(e){var t=this,r=e.api,a=r.config;r.soon=function(e){var u=arguments.length<=1||void 0===arguments[1]?i:arguments[1],l=arguments.length<=2||void 0===arguments[2]?i:arguments[2];if(!a.ignoreSelfConcurrent||!a.pending){a.overrideSelfConcurrent&&a._lastRequester&&(a._lastRequester.abort(),delete a._lastRequester);var p=t.makeVars(e),f=function(){t.remoteRequest(p,a).then(function(e){u({fromStorage:n,content:e})})["catch"](function(e){l(e)})};r.storageUseable?(p.queryString=s(p.data)?"no-query-string":JSON.stringify(c(p.data)),r.storage.has(p.queryString).then(function(e){e.has&&u({fromStorage:o,content:e.value}),f()})):f()}}}}])});